<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TxMS PRO | Geospatial Command</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --bg-body: #05070a; --bg-sidebar: #0f121a; --bg-card: #151921; --accent-purple: #8b5cf6; --text-main: #f8fafc; --text-muted: #94a3b8; --success: #10b981; --cyan: #06b6d4; --warning: #fbbf24; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        /* Overlays */
        .history-overlay, .daily-overlay, .maintenance-overlay { position: fixed; top: 0; left: 80px; width: calc(100% - 80px); height: 100%; background: var(--bg-body); z-index: 500; padding: 30px; display: none; overflow-y: auto; }
        
        /* Components */
        .btn-action { background: var(--accent-purple); color: white; border: none; padding: 8px 16px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.85rem; }
        
        /* Time Filter Buttons */
        .time-filters { display: flex; background: #1c212c; border-radius: 10px; padding: 4px; gap: 5px; margin-bottom: 20px; }
        .time-btn { background: transparent; border: none; color: #888; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; transition: 0.2s; }
        .time-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .time-btn.active { background: var(--accent-purple); color: white; box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); }

        #appContainer { display: block; width: 100%; } 
        
        /* Sidebar */
        .sidebar { width: 80px; background-color: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding-top: 20px; position: fixed; height: 100%; z-index: 100; border-right: 1px solid #2d3748; }
        .nav-item { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { background-color: var(--accent-purple); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        
        /* Layout */
        .main-content { margin-left: 80px; padding: 30px; width: calc(100% - 80px); max-width: 100%; flex-grow: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; border-radius: 15px; border: 1px solid transparent; transition: 0.5s; }
        .device-selector { background: #1c212c; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 10px; font-size: 0.9rem; margin-left: 15px; cursor: pointer; outline: none; }
        .mute-btn { background: none; border: 1px solid #444; color: #888; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; margin-left: 10px; }
        .mute-btn.active { border-color: #ef4444; color: #ef4444; }
        
        /* Status Badges */
        .status-badge { padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; transition: all 0.3s ease; }
        .status-online { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
        .status-offline { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #64748b; }
        
        /* Cards */
        .card { background-color: var(--bg-card); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; align-items: stretch; }
        .stat-card { background: #1a1f2b; border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; height: 100%; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent-purple); }
        .stat-icon { font-size: 1.4rem; margin-bottom: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin: 5px 0; color: white; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; }
        .stat-pill { padding: 4px 12px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; color: white; width: 90%; }
        
        /* Dashboard Layout */
        .dashboard-split { display: grid; grid-template-columns: 2fr 1.5fr; gap: 25px; margin-bottom: 25px; align-items: stretch; }
        @media (max-width: 1200px) { .dashboard-split { grid-template-columns: 1fr; } }
        .big-chart-card { display: flex; flex-direction: column; height: 100%; }
        .small-charts-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; height: 100%; }
        .small-chart-card { padding: 15px; display: flex; flex-direction: column; height: 100%; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted); }
        .chart-box { flex-grow: 1; position: relative; width: 100%; min-height: 0; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-purple); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* Data Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table td, .data-table th { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); text-align: left; }
        
        /* Map & Geo Controls */
        #map { width: 100%; height: 500px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; }
        .leaflet-container { background: #1a1e29; }
        .leaflet-popup-content-wrapper { background: #1a1e29; color: white; border: 1px solid var(--accent-purple); border-radius: 10px; }
        .leaflet-popup-tip { background: var(--accent-purple); }
        .manual-geo-controls { background: #1a1e29; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .geo-input { background: #111; border: 1px solid #444; padding: 10px; color: white; border-radius: 6px; outline: none; width: 140px; }
        .geo-input:focus { border-color: var(--accent-purple); }
        .geo-btn { background: var(--accent-purple); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .geo-btn:hover { opacity: 0.9; }

        /* Sliders */
        .cal-slider { width: 100%; margin: 10px 0; cursor: pointer; }
        .cal-group { margin-bottom: 15px; }
        .cal-label { font-size: 0.8rem; color: #aaa; display: flex; justify-content: space-between; }
        
        /* Date Picker */
        .date-input { background: #1c212c; color: white; border: 1px solid #444; padding: 8px 12px; border-radius: 8px; outline: none; cursor: pointer; }
        
        /* Historian Layout (Split) */
        .historian-container { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
        .chart-stack { display: flex; flex-direction: column; gap: 20px; }
        .chart-container-single { height: 250px; width: 100%; position: relative; }
        
        /* Summary Panel on Right */
        .summary-panel { position: sticky; top: 20px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .summary-label { color: #94a3b8; font-size: 0.9rem; }
        .summary-val { color: white; font-weight: bold; font-family: monospace; font-size: 1rem; }

        /* Control Panel */
        .control-panel { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; justify-content: space-between; }
        .checkbox-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 0.9rem; cursor: pointer; }

        /* Custom Unified Tooltip (Hover) */
        #unified-tooltip { opacity: 0; position: absolute; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent-purple); border-radius: 8px; pointer-events: none; color: white; padding: 10px; font-size: 0.85rem; z-index: 1000; transition: all 0.1s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 150px; }
        .tooltip-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .tooltip-label { color: #94a3b8; }
        .tooltip-value { font-weight: bold; }

        /* Mobile */
        @media (max-width: 1000px) { .historian-container { grid-template-columns: 1fr; } .summary-panel { position: static; margin-bottom: 20px; } }
        @media (max-width: 768px) { .sidebar { width: 100%; height: 60px; bottom: 0; top: auto; flex-direction: row; justify-content: space-around; padding: 0; border-right: none; border-top: 1px solid #2d3748; background: #0f121a; } .nav-item { width: 100%; margin: 0; border-radius: 0; } .main-content { margin-left: 0; width: 100%; padding: 15px; padding-bottom: 80px; } .header { flex-direction: column; align-items: flex-start; gap: 15px; } .header > div { width: 100%; display: flex; justify-content: space-between; align-items: center; } .dashboard-split { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; } .history-overlay, .daily-overlay, .maintenance-overlay { left: 0; width: 100%; padding: 15px; padding-bottom: 80px; z-index: 2000; } .data-table { display: block; overflow-x: auto; white-space: nowrap; } .manual-geo-controls { flex-direction: column; align-items: stretch; } .geo-input { width: 100%; } #map { height: 400px; } .control-panel { flex-direction: column; align-items: flex-start; } .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; width: 100%; } }
    </style>
</head>
<body>

    <div id="unified-tooltip"></div>

    <div id="appContainer">
        <nav class="sidebar">
            <div style="color:var(--accent-purple); font-weight:bold; margin:20px 0;">TxMS</div>
            <div class="nav-item active" id="navDash" onclick="showView('dashboardView')"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" id="navHist" onclick="showView('historyView')"><i class="fa-solid fa-chart-area"></i></div>
            <div class="nav-item" id="navDaily" onclick="showView('dailyView')"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="nav-item" id="navMaint" onclick="showView('maintenanceView')"><i class="fa-solid fa-screwdriver-wrench"></i></div>
        </nav>

        <main class="main-content" id="dashboardView">
            <div class="header">
                <div><h1>TxMS PRO</h1><span id="roleDisplay" style="color:var(--text-muted)">System Operator</span><select id="deviceSelect" class="device-selector"><option value="Tx01" selected>Tx01 (Main Node)</option></select></div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute Alarms"><i class="fa-solid fa-volume-high"></i></button>
                    <div id="netStatus" class="status-badge status-offline">CONNECTING...</div>
                </div>
            </div>

            <div class="card" style="padding: 0; margin-bottom: 25px; position: relative;">
                <div style="background: rgba(139, 92, 246, 0.1); padding: 12px 20px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between;">
                    <span style="font-size: 0.85rem; font-weight: bold; color: var(--accent-purple);">GEOSPATIAL FLEET MONITOR</span>
                    <button onclick="toggleGeoControls()" style="background: none; border: none; color: #555; cursor: pointer; font-size: 0.7rem;">MANAGE LOCATIONS</button>
                </div>
                
                <div id="geoControlsPanel" class="manual-geo-controls" style="display: none; border-bottom: 1px solid #333; margin: 0; border-radius: 0;">
                    <div style="flex-grow: 1;">
                        <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold;">UPDATE NODE LOCATION</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="inputDeviceId" class="geo-input" value="Tx01" readonly>
                            <input type="number" id="inputLat" class="geo-input" placeholder="Latitude" step="0.000001">
                            <input type="number" id="inputLng" class="geo-input" placeholder="Longitude" step="0.000001">
                            <button class="geo-btn" onclick="saveManualLocation()"><i class="fa-solid fa-plus"></i> UPDATE</button>
                        </div>
                    </div>
                </div>

                <div id="map" style="border: none; margin: 0; border-radius: 0 0 20px 20px;"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" id="card_v"><i class="fa-solid fa-bolt stat-icon" style="color: #7c3aed;"></i><div class="stat-value" id="v">--</div><div class="stat-label">Main Voltage</div><div class="stat-pill" style="background: #7c3aed;">Real-time</div></div>
                <div class="stat-card" id="card_c"><i class="fa-solid fa-plug stat-icon" style="color: #06b6d4;"></i><div class="stat-value"><span id="c1">--</span> / <span id="c2">--</span></div><div class="stat-label">Current (L1 / L2)</div><div class="stat-pill" style="background: #06b6d4;">Amperage</div></div>
                <div class="stat-card" id="card_pf"><i class="fa-solid fa-wave-square stat-icon" style="color: #d946ef;"></i><div class="stat-value" id="pf">--</div><div class="stat-label">Power Factor</div><div class="stat-pill" style="background: #d946ef;">Efficiency</div></div>
                <div class="stat-card" id="card_t"><i class="fa-solid fa-temperature-half stat-icon" style="color: #ef4444;"></i><div class="stat-value" id="t">--</div><div class="stat-label">Transformer Temp</div><div class="stat-pill" style="background: #ef4444;">Thermal</div></div>
                <div class="stat-card" id="card_vib"><i class="fa-solid fa-bell stat-icon" style="color: #fbbf24;"></i><div class="stat-value" id="vib">--</div><div class="stat-label">Vibration Level</div><div class="stat-pill" style="background: #fbbf24;">Physical</div></div>
            </div>

            <div class="dashboard-split">
                <div class="card big-chart-card">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color:white; font-size:1rem;">Real Time Current Analysis</h3>
                        <span style="color:var(--text-muted); font-size:0.8rem;">Load balance monitoring</span>
                    </div>
                    <div class="chart-box"><canvas id="chartCurr"></canvas></div>
                </div>

                <div class="small-charts-grid">
                    <div class="card small-chart-card"><div class="chart-header"><span>Voltage</span></div><div class="chart-box"><canvas id="chartVolt"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>PF Trend</span></div><div class="chart-box"><canvas id="chartPF"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>Temp</span></div><div class="chart-box"><canvas id="chartTemp"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>Vibration</span></div><div class="chart-box"><canvas id="chartVib"></canvas></div></div>
                </div>
            </div>

            <div class="card" style="height: 400px; overflow-y: hidden; display: flex; flex-direction: column;">
                <h3 style="color:white; margin-bottom: 15px;">System Event Logs</h3>
                <div style="overflow-y: auto; flex-grow: 1;">
                    <table class="data-table">
                        <thead><tr><th>TIMESTAMP</th><th>EVENT DESCRIPTION</th><th>TYPE</th></tr></thead>
                        <tbody id="eventLogBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <div class="history-overlay" id="historyView">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div><h2>ANALYTICAL HISTORIAN</h2><span style="color:var(--text-muted); font-size: 0.8rem;">Visual Trend Analysis</span></div>
                <div><button class="btn-action" style="background:#333;" onclick="showView('dashboardView')">CLOSE</button></div>
            </div>
            
            <div class="control-panel">
                <div class="time-filters" style="margin-bottom:0;">
                    <button class="time-btn active" id="btnLive" onclick="setChartRange(0, this)">LIVE</button>
                    <button class="time-btn" onclick="setChartRange(1, this)">1H</button>
                    <button class="time-btn" onclick="setChartRange(6, this)">6H</button>
                    <button class="time-btn" onclick="setChartRange(12, this)">12H</button>
                    <button class="time-btn" onclick="setChartRange(24, this)">24H</button>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="cb_v" checked onchange="toggleChartDataset(0)"> Voltage</label>
                    <label class="checkbox-item"><input type="checkbox" id="cb_c1" checked onchange="toggleChartDataset(1)"> L1</label>
                    <label class="checkbox-item"><input type="checkbox" id="cb_c2" checked onchange="toggleChartDataset(2)"> L2</label>
                    <label class="checkbox-item"><input type="checkbox" id="cb_pf" checked onchange="toggleChartDataset(3)"> PF</label>
                    <label class="checkbox-item"><input type="checkbox" id="cb_t" checked onchange="toggleChartDataset(4)"> Temp</label>
                    <label class="checkbox-item"><input type="checkbox" id="cb_vib" checked onchange="toggleChartDataset(5)"> Vib</label>
                </div>
            </div>

            <div class="historian-container">
                <div class="chart-stack">
                    <div class="card" style="padding:15px;">
                        <h4 style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">ELECTRICAL (Voltage / Current)</h4>
                        <div class="chart-container-single"><canvas id="histChartElec"></canvas></div>
                    </div>
                    <div class="card" style="padding:15px;">
                        <h4 style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">EFFICIENCY (Power Factor)</h4>
                        <div class="chart-container-single"><canvas id="histChartPF"></canvas></div>
                    </div>
                    <div class="card" style="padding:15px;">
                        <h4 style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">PHYSICAL HEALTH (Temp / Vibration)</h4>
                        <div class="chart-container-single"><canvas id="histChartPhys"></canvas></div>
                    </div>
                </div>

                <div class="summary-panel">
                    <div class="card" style="height: 100%; border-color: var(--accent-purple);">
                        <h3 style="color:white; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px;">Data Point Summary</h3>
                        
                        <div id="summary-content" style="opacity: 0.5;">
                            <div style="text-align:center; color:#666; margin-top:50px;">
                                <i class="fa-solid fa-arrow-pointer" style="font-size: 2rem; margin-bottom: 15px;"></i><br>
                                Click on any graph point<br>to view details here.
                            </div>
                        </div>

                        <div id="summary-data" style="display: none;">
                            <div class="summary-item">
                                <span class="summary-label">Timestamp</span>
                                <span class="summary-val" id="sum_time" style="font-size: 0.85rem; color: #ccc;">--:--:--</span>
                            </div>
                            
                            <div class="summary-item">
                                <span class="summary-label">System Status</span>
                                <span class="summary-val" id="sum_status" style="font-size: 0.85rem;">--</span>
                            </div>

                            <div class="summary-item">
                                <span class="summary-label">Voltage</span>
                                <span class="summary-val" style="color: #7c3aed;" id="sum_v">-- V</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Current L1</span>
                                <span class="summary-val" style="color: #10b981;" id="sum_c1">-- A</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Current L2</span>
                                <span class="summary-val" style="color: #06b6d4;" id="sum_c2">-- A</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Power Factor</span>
                                <span class="summary-val" style="color: #d946ef;" id="sum_pf">--</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Temperature</span>
                                <span class="summary-val" style="color: #ef4444;" id="sum_t">-- °C</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Vibration</span>
                                <span class="summary-val" style="color: #fbbf24;" id="sum_vib">-- g</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="daily-overlay" id="dailyView">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <div><h2>DAILY REPORT</h2></div>
                <button class="btn-action" style="background:#333" onclick="showView('dashboardView')">CLOSE</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; flex-wrap:wrap; gap:15px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:#aaa; font-size:0.9rem;">Filter by Date:</span>
                    <input type="date" id="reportDate" class="date-input" onchange="filterReportDate()">
                    <button class="btn-action" style="background:#333; padding: 6px 12px;" onclick="document.getElementById('reportDate').value=''; filterReportDate()">CLEAR</button>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-action" style="background: #10b981;" onclick="downloadExcel()"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
                    <button class="btn-action" style="background: #ef4444;" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
                </div>
            </div>

            <div class="card" style="min-height: 500px; overflow-y:auto; max-height:70vh;">
                <table class="data-table">
                    <thead><tr><th>TIME</th><th>VOLT</th><th>L1</th><th>L2</th><th>TEMP</th><th>VIB</th><th>PF</th><th>STATUS</th></tr></thead>
                    <tbody id="dailyTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="maintenance-overlay" id="maintenanceView">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <div><h2>SYSTEM MAINTENANCE</h2><span style="color:var(--text-muted)">Admin Controls</span></div>
                <button class="btn-action" style="background:#333" onclick="showView('dashboardView')">CLOSE</button>
            </div>

             <div class="card" style="margin-bottom: 25px; border-color: #d946ef;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div><h3 style="color: white; font-size: 1rem;">Safety Interlock</h3><span style="color: #aaa; font-size: 0.8rem;">Master Alarm Control</span></div>
                    <label class="switch"><input type="checkbox" id="alarmToggle" onchange="toggleAlarm(this)"><span class="slider"></span></label>
                </div>
                <div id="armStatusText" style="margin-top: 10px; font-weight: bold; color: #ef4444; text-align: right;">DISARMED</div>
            </div>

             <div class="card" style="margin-bottom: 25px; border-color: #fbbf24;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div><h3 style="color: white; font-size: 1rem;">Simulation Mode</h3><span style="color: #aaa; font-size: 0.8rem;">Override Sensor Inputs</span></div>
                    <label class="switch"><input type="checkbox" id="testModeToggle" onchange="toggleTestMode(this)"><span class="slider"></span></label>
                </div>
                
                <div id="simulationControls" style="opacity: 0.3; pointer-events: none; transition: 0.3s;">
                    <div class="cal-group"><div class="cal-label"><span>Sim Voltage</span><span id="sim_v_val">220V</span></div><input type="range" min="0" max="300" value="220" class="cal-slider" oninput="updateSimulation('v', this.value)"></div>
                    <div class="cal-group"><div class="cal-label"><span>Sim Current L1</span><span id="sim_c1_val">5A</span></div><input type="range" min="0" max="1000" value="5" class="cal-slider" oninput="updateSimulation('c1', this.value)"></div>
                    <div class="cal-group"><div class="cal-label"><span>Sim Current L2</span><span id="sim_c2_val">5A</span></div><input type="range" min="0" max="1000" value="5" class="cal-slider" oninput="updateSimulation('c2', this.value)"></div>
                    <div class="cal-group"><div class="cal-label"><span>Sim Power Factor</span><span id="sim_pf_val">0.9</span></div><input type="range" min="0" max="1" step="0.01" value="0.9" class="cal-slider" oninput="updateSimulation('pf', this.value)"></div>
                    <div class="cal-group"><div class="cal-label"><span>Sim Temp</span><span id="sim_t_val">30°C</span></div><input type="range" min="0" max="150" value="30" class="cal-slider" oninput="updateSimulation('t', this.value)"></div>
                    <div class="cal-group"><div class="cal-label"><span>Sim Vibration</span><span id="sim_vib_val">0g</span></div><input type="range" min="0" max="5" step="0.01" value="0" class="cal-slider" oninput="updateSimulation('vib', this.value)"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="color:white; margin-bottom: 20px;">Sensor Calibration</h3>
                <div class="cal-group"><div class="cal-label"><span>Voltage Cal Factor</span><span id="val_v">0.328381</span></div><input type="range" min="0" max="1.0" step="0.000001" value="0.328381" class="cal-slider" oninput="document.getElementById('val_v').innerText=this.value; logEvent('Calibration Updated: Voltage', 'MAINT')"></div>
                <div class="cal-group"><div class="cal-label"><span>Current L1 Cal Factor</span><span id="val_c1">0.066</span></div><input type="range" min="0" max="0.5" step="0.001" value="0.066" class="cal-slider" oninput="document.getElementById('val_c1').innerText=this.value; logEvent('Calibration Updated: Current L1', 'MAINT')"></div>
                <div class="cal-group"><div class="cal-label"><span>Current L2 Cal Factor</span><span id="val_c2">0.066</span></div><input type="range" min="0" max="0.5" step="0.001" value="0.066" class="cal-slider" oninput="document.getElementById('val_c2').innerText=this.value; logEvent('Calibration Updated: Current L2', 'MAINT')"></div>
                <button class="btn-action" style="width:100%" onclick="logEvent('Calibration Settings Saved', 'SUCCESS')">SAVE CALIBRATION</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = "https://txms-backend.onrender.com/api"; 
    const DEVICE_ID = "Tx01";

    // --- STATE VARIABLES ---
    let sessionLog = []; 
    let map = null;
    let deviceMarker = null;
    let isMuted = false;
    let pollInterval = null;
    let chartElec = null, chartPF = null, chartPhys = null;
    let chartTimeWindow = 0; // 0=Live
    let isSimulationMode = false;
    let simValues = { v: 220, c1: 5, c2: 5, pf: 0.9, t: 30, vib: 0 };
    let currentChartData = []; 
    let simUploadTimer = null; // Debounce Timer

    window.onload = function() {
        initMap();
        startPolling();
        initAudio();
        initHistorianCharts(); 
        logEvent("System Initialized", "INFO");
    };

    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function toggleMute() { 
        isMuted = !isMuted; 
        document.getElementById('muteBtn').classList.toggle('active', isMuted); 
        logEvent(isMuted ? "System Muted" : "System Unmuted", "INFO");
    }

    function startPolling() {
        if(pollInterval) clearInterval(pollInterval);
        fetchData();
        pollInterval = setInterval(fetchData, 2000);
    }

    async function fetchData() {
        try {
            const response = await fetch(`${API_URL}/status/${DEVICE_ID}`);
            const data = await response.json();

            if(data.message === "No data") return;

            const statusBadge = document.getElementById('netStatus');
            if(statusBadge.innerText === "OFFLINE") logEvent("Connection Restored", "SUCCESS");

            statusBadge.innerText = "ONLINE";
            statusBadge.className = "status-badge status-online";
            
            updateDashboard(data);

        } catch (error) {
            console.error("Fetch Error:", error);
            const statusBadge = document.getElementById('netStatus');
            if(statusBadge.innerText !== "OFFLINE") logEvent("Connection Lost", "ALERT");
            
            statusBadge.innerText = "OFFLINE";
            statusBadge.className = "status-badge status-offline";
        }
    }

    function updateDashboard(d) {
        let v, c1, c2, t, vib, pf;

        if (isSimulationMode) {
            v = parseFloat(simValues.v);
            c1 = parseFloat(simValues.c1);
            c2 = parseFloat(simValues.c2);
            t = parseFloat(simValues.t);
            vib = parseFloat(simValues.vib);
            pf = parseFloat(simValues.pf);
        } else {
            v = d.voltage || 0;
            c1 = d.currentL1 || 0;
            c2 = d.currentL2 || 0;
            t = d.temp || 0;
            vib = d.vib || 0;
            pf = d.pf || 0;
        }

        document.getElementById('v').innerText = v.toFixed(1)+"V";
        document.getElementById('pf').innerText = pf.toFixed(2); 
        document.getElementById('c1').innerText = c1.toFixed(1);
        document.getElementById('c2').innerText = c2.toFixed(1);
        document.getElementById('t').innerText = t.toFixed(1)+"°C";
        document.getElementById('vib').innerText = vib.toFixed(2)+"g";

        updateSingleChart(vChart, v); updateSingleChart(pfChart, pf); 
        updateSingleChart(tChart, t); updateSingleChart(vibChart, vib);
        
        cChart.data.datasets[0].data.push(c1); cChart.data.datasets[0].data.shift();
        cChart.data.datasets[1].data.push(c2); cChart.data.datasets[1].data.shift(); 
        cChart.update();

        if(!isSimulationMode && d.config && d.config.location && d.config.location.lat !== 0) {
            const lat = d.config.location.lat;
            const lng = d.config.location.lng;
            if(map && deviceMarker) {
                deviceMarker.setLatLng([lat, lng]);
                map.setView([lat, lng], 14);
                document.getElementById('inputLat').value = lat;
                document.getElementById('inputLng').value = lng;
            }
        }

        if (d.alarmArmed !== undefined) {
            const toggle = document.getElementById('alarmToggle');
            const statusText = document.getElementById('armStatusText');
            if (toggle.checked !== d.alarmArmed) {
                toggle.checked = d.alarmArmed;
                if (d.alarmArmed) {
                    statusText.innerText = "SYSTEM ARMED";
                    statusText.style.color = "#ef4444";
                    logEvent("Remote Arm Command Received", "ALERT");
                } else {
                    statusText.innerText = "SYSTEM DISARMED";
                    statusText.style.color = "#10b981";
                    logEvent("Remote Disarm Command Received", "INFO");
                }
            }
        }

        const now = new Date();
        sessionLog.push({time: now, v, c1, c2, pf, t, vib});
        if (sessionLog.length > 5000) sessionLog.shift();
        
        filterReportDate(); 
        updateHistoryChartData();
    }

    function logEvent(msg, type) {
        const tbody = document.getElementById("eventLogBody");
        const color = type === 'ALERT' ? '#ef4444' : (type === 'SUCCESS' ? '#10b981' : (type === 'MAINT' ? '#fbbf24' : '#3b82f6'));
        const row = `<tr>
            <td style="color:#888; font-size:0.85rem;">${new Date().toLocaleTimeString()}</td>
            <td style="color:white; font-weight:500;">${msg}</td>
            <td><span class="stat-pill" style="background:${color}">${type}</span></td>
        </tr>`;
        tbody.insertAdjacentHTML("afterbegin", row);
    }

    async function toggleAlarm(checkbox) {
        const newState = checkbox.checked;
        const statusText = document.getElementById('armStatusText');
        if (newState) { statusText.innerText = "ARMING..."; statusText.style.color = "#ef4444"; } 
        else { statusText.innerText = "DISARMING..."; statusText.style.color = "#10b981"; }

        try {
            const response = await fetch(`${API_URL}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: DEVICE_ID, alarm_armed: newState })
            });
            if (!response.ok) { alert("Failed!"); checkbox.checked = !newState; } 
            else { logEvent(newState ? "User Armed System" : "User Disarmed System", "ALERT"); }
        } catch (error) { alert("Network Error"); checkbox.checked = !newState; }
    }

    // --- SIMULATION LOGIC (WITH UPLOAD) ---
    function toggleTestMode(checkbox) {
        isSimulationMode = checkbox.checked;
        const controls = document.getElementById('simulationControls');
        
        // Notify Server of Mode Change
        fetch(`${API_URL}/simulation`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: DEVICE_ID, active: isSimulationMode, ...simValues })
        });

        if(isSimulationMode) {
            controls.style.opacity = "1"; controls.style.pointerEvents = "auto";
            logEvent("Simulation Mode STARTED", "MAINT");
        } else {
            controls.style.opacity = "0.3"; controls.style.pointerEvents = "none";
            logEvent("Simulation Mode ENDED", "INFO");
        }
    }

    function updateSimulation(param, value) {
        simValues[param] = value;
        const unit = (param === 'v') ? 'V' : (param === 'vib' ? 'g' : (param === 'pf' ? '' : (param === 't' ? '°C' : 'A')));
        document.getElementById(`sim_${param}_val`).innerText = value + unit;
        
        if(isSimulationMode) {
            updateDashboard({ alarmArmed: document.getElementById('alarmToggle').checked });
        }

        // Debounced Upload to Server
        clearTimeout(simUploadTimer);
        simUploadTimer = setTimeout(sendSimulationData, 500); 
    }

    async function sendSimulationData() {
        if(!isSimulationMode) return;
        try {
            await fetch(`${API_URL}/simulation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device_id: DEVICE_ID,
                    active: true,
                    v: parseFloat(simValues.v),
                    c1: parseFloat(simValues.c1),
                    c2: parseFloat(simValues.c2),
                    pf: parseFloat(simValues.pf),
                    t: parseFloat(simValues.t),
                    vib: parseFloat(simValues.vib)
                })
            });
            console.log("Sim Uploaded");
        } catch (e) { console.error("Sim Upload Fail", e); }
    }

    function initMap() {
        if(map) return;
        map = L.map('map').setView([14.5995, 120.9842], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class='marker-normal'></div>` });
        deviceMarker = L.marker([14.5995, 120.9842], {icon: icon}).addTo(map);
    }
    function toggleGeoControls() {
        const p = document.getElementById('geoControlsPanel');
        p.style.display = p.style.display === 'none' ? 'flex' : 'none';
        if(map) map.invalidateSize();
    }
    async function saveManualLocation() {
        const lat = parseFloat(document.getElementById('inputLat').value);
        const lng = parseFloat(document.getElementById('inputLng').value);
        if(!lat || !lng) return alert("Invalid Coords");
        await fetch(`${API_URL}/location`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ device_id: DEVICE_ID, lat, lng })
        });
        alert("Location Updated!"); logEvent("Location Updated Manually", "SUCCESS");
    }

    function createMiniChart(e,t){return new Chart(document.getElementById(e).getContext("2d"),{type:"line",data:{labels:Array(20).fill(""),datasets:[{data:Array(20).fill(0),borderColor:t,borderWidth:2,pointRadius:0,tension:.4,fill:!0,backgroundColor:t+"11"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{display:!1},y:{display:!0,grid:{color:"#333"},ticks:{color:"#bbb",font:{size:11}}}},plugins:{legend:{display:!1}},animation:!1}})}
    const vChart=createMiniChart("chartVolt","#7c3aed"),pfChart=createMiniChart("chartPF","#d946ef"),tChart=createMiniChart("chartTemp","#ef4444"),vibChart=createMiniChart("chartVib","#fbbf24"),cChart=new Chart(document.getElementById("chartCurr").getContext("2d"),{type:"line",data:{labels:Array(20).fill(""),datasets:[{label:"L1",data:Array(20).fill(0),borderColor:"#10b981",borderWidth:2,pointRadius:0,tension:.4},{label:"L2",data:Array(20).fill(0),borderColor:"#06b6d4",borderWidth:2,pointRadius:0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{display:!1},y:{display:!0,grid:{color:"#444"},ticks:{color:"#ffffff",font:{size:12,weight:"bold"}}}},plugins:{legend:{display:!0,labels:{color:"#ccc"}}},animation:!1}});
    function updateSingleChart(e,t){e.data.datasets[0].data.push(t),e.data.datasets[0].data.shift(),e.update()}

    // --- SEPARATED HISTORIAN CHARTS WITH CLICK HANDLER ---
    function initHistorianCharts() {
        // --- CUSTOM TOOLTIP HOVER ---
        const tooltipHandler = (context) => {
            const { chart, tooltip } = context;
            const tooltipEl = document.getElementById('unified-tooltip');
            if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }
            if (tooltip.dataPoints.length > 0) {
                const index = tooltip.dataPoints[0].dataIndex;
                const data = currentChartData[index];
                if (data) {
                    let html = `<div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #444; padding-bottom:5px;">${data.time.toLocaleTimeString()}</div>`;
                    if(document.getElementById('cb_v').checked) html += `<div class="tooltip-row"><span class="tooltip-label">Voltage:</span> <span class="tooltip-value" style="color:#7c3aed">${data.v.toFixed(1)} V</span></div>`;
                    if(document.getElementById('cb_c1').checked) html += `<div class="tooltip-row"><span class="tooltip-label">Cur L1:</span> <span class="tooltip-value" style="color:#10b981">${data.c1.toFixed(1)} A</span></div>`;
                    if(document.getElementById('cb_c2').checked) html += `<div class="tooltip-row"><span class="tooltip-label">Cur L2:</span> <span class="tooltip-value" style="color:#06b6d4">${data.c2.toFixed(1)} A</span></div>`;
                    if(document.getElementById('cb_pf').checked) html += `<div class="tooltip-row"><span class="tooltip-label">PF:</span> <span class="tooltip-value" style="color:#d946ef">${data.pf.toFixed(2)}</span></div>`;
                    if(document.getElementById('cb_t').checked) html += `<div class="tooltip-row"><span class="tooltip-label">Temp:</span> <span class="tooltip-value" style="color:#ef4444">${data.t.toFixed(1)} °C</span></div>`;
                    if(document.getElementById('cb_vib').checked) html += `<div class="tooltip-row"><span class="tooltip-label">Vib:</span> <span class="tooltip-value" style="color:#fbbf24">${data.vib.toFixed(2)} g</span></div>`;
                    tooltipEl.innerHTML = html;
                    const position = context.chart.canvas.getBoundingClientRect();
                    tooltipEl.style.opacity = 1;
                    tooltipEl.style.left = position.left + window.pageXOffset + tooltip.caretX + 15 + 'px';
                    tooltipEl.style.top = position.top + window.pageYOffset + tooltip.caretY + 'px';
                }
            }
        };

        // --- CLICK HANDLER TO UPDATE SIDEBAR ---
        const clickHandler = (e, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const data = currentChartData[index];
                if(data) updateSummaryPanel(data);
            }
        };

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false }, 
            scales: { x: { ticks: { color: '#888' }, grid: { color: '#333' } }, y: { ticks: { color: '#888' }, grid: { color: '#333' } } },
            elements: { point: { radius: 0 } }, // Remove points
            plugins: { 
                legend: { labels: { color: '#fff' } },
                tooltip: { enabled: false, external: tooltipHandler }
            },
            onClick: clickHandler
        };

        chartElec = new Chart(document.getElementById('histChartElec').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Voltage', data: [], borderColor: '#7c3aed', tension: 0.4 },
                { label: 'L1', data: [], borderColor: '#10b981', tension: 0.4 },
                { label: 'L2', data: [], borderColor: '#06b6d4', tension: 0.4 }
            ]}, options: commonOptions
        });

        chartPF = new Chart(document.getElementById('histChartPF').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Power Factor', data: [], borderColor: '#d946ef', tension: 0.4 }]}, 
            options: commonOptions
        });

        chartPhys = new Chart(document.getElementById('histChartPhys').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Temp', data: [], borderColor: '#ef4444', tension: 0.4 },
                { label: 'Vibration', data: [], borderColor: '#fbbf24', tension: 0.4 }
            ]}, options: commonOptions
        });
    }

    function detectAbnormality(d) {
        let issues = [];
        if (d.v > 264) issues.push("High Voltage");
        if (d.v < 216) issues.push("Low Voltage");
        if (d.c1 > 312 || d.c2 > 312) issues.push("Overcurrent");
        if (d.t > 75) issues.push("Overheating");
        if (d.vib > 0.20) issues.push("High Vibration");
        if (d.pf < 0.85) issues.push("Poor Power Factor");
        return issues.length > 0 ? issues.join(", ") : "Normal Operation";
    }

    function updateSummaryPanel(data) {
        document.getElementById('summary-content').style.display = 'none';
        document.getElementById('summary-data').style.display = 'block';
        
        document.getElementById('sum_time').innerText = data.time.toLocaleTimeString();
        document.getElementById('sum_v').innerText = data.v.toFixed(1) + " V";
        document.getElementById('sum_c1').innerText = data.c1.toFixed(1) + " A";
        document.getElementById('sum_c2').innerText = data.c2.toFixed(1) + " A";
        document.getElementById('sum_pf').innerText = data.pf.toFixed(2);
        document.getElementById('sum_t').innerText = data.t.toFixed(1) + " °C";
        document.getElementById('sum_vib').innerText = data.vib.toFixed(2) + " g";

        const statusEl = document.getElementById('sum_status');
        const statusText = detectAbnormality(data);
        statusEl.innerText = statusText;
        statusEl.style.color = statusText === "Normal Operation" ? "#10b981" : "#ef4444";
    }

    function toggleChartDataset(idx) {
        let targetChart, dsIndex;
        if(idx <= 2) { targetChart = chartElec; dsIndex = idx; }
        else if(idx === 3) { targetChart = chartPF; dsIndex = 0; }
        else { targetChart = chartPhys; dsIndex = idx - 4; }

        if(targetChart) {
            const meta = targetChart.getDatasetMeta(dsIndex);
            meta.hidden = meta.hidden === null ? !targetChart.data.datasets[dsIndex].hidden : null;
            targetChart.update();
        }
    }

    function setChartRange(hours, btn) {
        chartTimeWindow = hours;
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateHistoryChartData();
    }

    function updateHistoryChartData() {
        if (!chartElec) return;
        
        let filteredData;
        const now = new Date();

        if (chartTimeWindow === 0) {
            filteredData = sessionLog.slice(-50);
        } else {
            const cutoff = new Date(now.getTime() - (chartTimeWindow * 60 * 60 * 1000));
            filteredData = sessionLog.filter(d => d.time >= cutoff);
            
            if(filteredData.length > 1000) {
                const step = Math.ceil(filteredData.length / 1000);
                filteredData = filteredData.filter((_, i) => i % step === 0);
            }
        }

        currentChartData = filteredData; 

        const labels = filteredData.map(d => d.time.toLocaleTimeString());

        chartElec.data.labels = labels;
        chartElec.data.datasets[0].data = filteredData.map(d => d.v);
        chartElec.data.datasets[1].data = filteredData.map(d => d.c1);
        chartElec.data.datasets[2].data = filteredData.map(d => d.c2);
        chartElec.update('none');

        chartPF.data.labels = labels;
        chartPF.data.datasets[0].data = filteredData.map(d => d.pf);
        chartPF.update('none');

        chartPhys.data.labels = labels;
        chartPhys.data.datasets[0].data = filteredData.map(d => d.t);
        chartPhys.data.datasets[1].data = filteredData.map(d => d.vib);
        chartPhys.update('none');
    }

    function filterReportDate() {
        const dateInput = document.getElementById('reportDate').value;
        const tbody = document.getElementById("dailyTableBody");
        tbody.innerHTML = "";

        let displayData = sessionLog.slice().reverse(); 

        if (dateInput) {
            const selectedDate = new Date(dateInput).toDateString();
            displayData = displayData.filter(log => log.time.toDateString() === selectedDate);
        } else {
            displayData = displayData.slice(0, 50); 
        }

        displayData.forEach(d => {
            const status = detectAbnormality(d);
            const color = status === "Normal Operation" ? "#10b981" : "#ef4444";
            let row = `<tr><td>${d.time.toLocaleTimeString()}</td><td>${d.v.toFixed(1)}</td><td>${d.c1.toFixed(1)}</td><td>${d.c2.toFixed(1)}</td><td>${d.t.toFixed(1)}</td><td>${d.vib.toFixed(2)}</td><td>${d.pf.toFixed(2)}</td><td><span style="color:${color}; font-weight:bold;">${status}</span></td></tr>`;
            tbody.insertAdjacentHTML("beforeend", row);
        });
        
        window.filteredExportData = displayData;
    }

    function downloadPDF() {
        const dataToExport = window.filteredExportData || sessionLog;
        if(dataToExport.length === 0) return alert("No data to export");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("TxMS PRO - Report Log", 14, 15);
        
        const tableColumn = ["Time", "Volt", "L1", "L2", "PF", "Temp", "Vib", "Status"];
        const tableRows = dataToExport.map(log => [
            log.time.toLocaleTimeString(), log.v.toFixed(1), log.c1.toFixed(1), log.c2.toFixed(1), log.pf.toFixed(2), log.t.toFixed(1), log.vib.toFixed(2), detectAbnormality(log)
        ]);

        doc.autoTable(tableColumn, tableRows, { startY: 20 });
        doc.save("TxMS_Report.pdf");
    }

    function downloadExcel() {
        const dataToExport = window.filteredExportData || sessionLog;
        if(dataToExport.length === 0) return alert("No data to export");
        
        const data = dataToExport.map(log => ({
            Date: log.time.toLocaleDateString(), Time: log.time.toLocaleTimeString(),
            Voltage: log.v, Current_L1: log.c1, Current_L2: log.c2, Power_Factor: log.pf, Temperature: log.t, Vibration: log.vib, Status: detectAbnormality(log)
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "TxMS Data");
        XLSX.writeFile(wb, "TxMS_Data_Export.xlsx");
    }

    function showView(e){
        ["dashboardView","historyView","dailyView","maintenanceView"].forEach(id => {
            const el = document.getElementById(id); if(el) el.style.display="none";
        });
        const target = document.getElementById(e); if(target) target.style.display="block";
        if(e === 'dashboardView' && map) setTimeout(()=>map.invalidateSize(), 200);
    }
</script>
</body>
</html>
