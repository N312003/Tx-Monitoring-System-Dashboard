<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TxMS PRO | Geospatial Command</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --bg-body: #05070a; --bg-sidebar: #0f121a; --bg-card: #151921; --accent-purple: #8b5cf6; --text-main: #f8fafc; --text-muted: #94a3b8; --success: #10b981; --cyan: #06b6d4; --warning: #fbbf24; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        #loginView, #authOverlay, #confirmOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1e29 0%, #05070a 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #authOverlay, #confirmOverlay { background: rgba(5, 7, 10, 0.95); backdrop-filter: blur(15px); display: none; }
        .history-overlay, .daily-overlay, .maintenance-overlay { position: fixed; top: 0; left: 80px; width: calc(100% - 80px); height: 100%; background: var(--bg-body); z-index: 500; padding: 30px; display: none; overflow-y: auto; }
        .login-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 400px; max-width: 90%; text-align: center; box-shadow: 0 0 50px rgba(139, 92, 246, 0.2); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; color: white; outline: none; transition: 0.3s; }
        .login-btn { width: 100%; padding: 12px; background: var(--accent-purple); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-action { background: var(--accent-purple); color: white; border: none; padding: 8px 16px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.85rem; }
        #appContainer { display: none; width: 100%; } 
        .sidebar { width: 80px; background-color: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding-top: 20px; position: fixed; height: 100%; z-index: 100; border-right: 1px solid #2d3748; }
        .nav-item { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { background-color: var(--accent-purple); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .logout-btn { margin-top: auto; margin-bottom: 30px; color: var(--danger) !important; }
        .main-content { margin-left: 80px; padding: 30px; width: calc(100% - 80px); max-width: 100%; flex-grow: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; border-radius: 15px; border: 1px solid transparent; transition: 0.5s; }
        .device-selector { background: #1c212c; color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 10px; font-size: 0.9rem; margin-left: 15px; cursor: pointer; outline: none; }
        .mute-btn { background: none; border: 1px solid #444; color: #888; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; margin-left: 10px; }
        .mute-btn.active { border-color: #ef4444; color: #ef4444; }
        .status-badge { padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; transition: all 0.3s ease; }
        .status-online { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
        .status-offline { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid #64748b; }
        .status-test { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .card { background-color: var(--bg-card); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; align-items: stretch; }
        .stat-card { background: #1a1f2b; border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; height: 100%; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent-purple); }
        .stat-icon { font-size: 1.4rem; margin-bottom: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin: 5px 0; color: white; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; }
        .stat-pill { padding: 4px 12px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; color: white; width: 90%; }
        .dashboard-split { display: grid; grid-template-columns: 2fr 1.5fr; gap: 25px; margin-bottom: 25px; align-items: stretch; }
        @media (max-width: 1200px) { .dashboard-split { grid-template-columns: 1fr; } }
        .big-chart-card { display: flex; flex-direction: column; height: 100%; }
        .small-charts-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; height: 100%; }
        .small-chart-card { padding: 15px; display: flex; flex-direction: column; height: 100%; }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted); }
        .chart-box { flex-grow: 1; position: relative; width: 100%; min-height: 0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-purple); }
        input:checked + .slider:before { transform: translateX(24px); }
        .chart-controls { display: flex; gap: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px 20px; border-radius: 12px; align-items: center; flex-wrap: wrap; }
        .chart-check { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; color: #ccc; }
        .chart-check input { accent-color: var(--accent-purple); transform: scale(1.2); cursor: pointer; }
        .filter-btn { background: #333; border: 1px solid #555; color: #ccc; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .date-picker { background: #1c212c; border: 1px solid #444; color: white; padding: 8px; border-radius: 8px; margin-right: 15px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table td, .data-table th { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); text-align: left; }
        .maint-card { background: #151921; border: 1px solid #d946ef; padding: 30px; border-radius: 15px; margin-bottom: 20px; }
        .sim-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; opacity: 0.5; pointer-events: none; transition: 0.3s; margin-top: 30px; }
        .cal-controls { display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 20px; }
        .sim-slider, .cal-slider { width: 100%; margin-top: 10px; cursor: pointer; }
        #map { width: 100%; height: 500px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; }
        .leaflet-container { background: #1a1e29; }
        .leaflet-popup-content-wrapper { background: #1a1e29; color: white; border: 1px solid var(--accent-purple); border-radius: 10px; }
        .leaflet-popup-tip { background: var(--accent-purple); }
        .manual-geo-controls { background: #1a1e29; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .geo-input { background: #111; border: 1px solid #444; padding: 10px; color: white; border-radius: 6px; outline: none; width: 140px; }
        .geo-input:focus { border-color: var(--accent-purple); }
        .geo-btn { background: var(--accent-purple); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .geo-btn:hover { opacity: 0.9; }
        .btn-delete { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; margin-top: 8px; width: 100%; }
        .marker-normal { background-color: #8b5cf6; width: 15px; height: 15px; border-radius: 50%; box-shadow: 0 0 10px #8b5cf6; border: 2px solid white; transition: 0.3s; }
        .marker-warning { background-color: #fbbf24; width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; animation: blink-yellow 1s infinite; }
        @keyframes blink-yellow { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(251, 191, 36, 0); } 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } }
        .marker-critical { background-color: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; animation: pulse-red-radiate 0.5s infinite; }
        @keyframes pulse-red-radiate { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.9); transform: scale(1); } 50% { transform: scale(1.2); } 100% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); transform: scale(1); } }
        @media (max-width: 768px) { .sidebar { width: 100%; height: 60px; bottom: 0; top: auto; flex-direction: row; justify-content: space-around; padding: 0; border-right: none; border-top: 1px solid #2d3748; background: #0f121a; } .nav-item { width: 100%; margin: 0; border-radius: 0; } .logout-btn { margin: 0 !important; color: #ef4444; } .main-content { margin-left: 0; width: 100%; padding: 15px; padding-bottom: 80px; } .header { flex-direction: column; align-items: flex-start; gap: 15px; } .header > div { width: 100%; display: flex; justify-content: space-between; align-items: center; } .dashboard-split { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; } .stat-card { padding: 15px; } .stat-value { font-size: 1.4rem; } .history-overlay, .daily-overlay, .maintenance-overlay { left: 0; width: 100%; padding: 15px; padding-bottom: 80px; z-index: 2000; } .data-table { display: block; overflow-x: auto; white-space: nowrap; } .manual-geo-controls { flex-direction: column; align-items: stretch; } .geo-input { width: 100%; } #map { height: 400px; } }
    </style>
</head>
<body>

    <section id="loginView" style="display: flex;">
        <div class="login-card">
            <h2 style="color:var(--accent-purple); margin-bottom: 10px;">Operator Verification</h2>
            <input type="email" id="email" placeholder="Email" class="login-input" onkeypress="if(event.key==='Enter') login()">
            <input type="password" id="password" placeholder="Password" class="login-input" onkeypress="if(event.key==='Enter') login()">
            <button class="login-btn" onclick="login()">AUTHENTICATE</button>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 15px; display: none;">Invalid credentials.</p>
        </div>
    </section>
    
    <div id="authOverlay"><div class="login-card" style="border-color: #d946ef;"><i class="fa-solid fa-lock" style="font-size: 3rem; color: #d946ef; margin-bottom: 20px;"></i><h2 id="authTitle" style="color:white; margin-bottom: 10px;">Restricted Area</h2><input type="password" id="reAuthPass" placeholder="Confirm Password" class="login-input" onkeypress="if(event.key==='Enter') verifyAction()"><button class="login-btn" onclick="verifyAction()" style="background: #d946ef;">UNLOCK</button><div onclick="closeAuthOverlay()" style="margin-top:15px; cursor:pointer;">Cancel</div></div></div>
    
    <div id="appContainer">
        <nav class="sidebar">
            <div style="color:var(--accent-purple); font-weight:bold; margin:20px 0;">TxMS</div>
            <div class="nav-item active" id="navDash" onclick="showView('dashboardView')"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" id="navHist" onclick="showView('historyView')"><i class="fa-solid fa-chart-area"></i></div>
            <div class="nav-item" id="navDaily" onclick="showView('dailyView')"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="nav-item" id="navMaint" onclick="showView('maintenanceView')"><i class="fa-solid fa-screwdriver-wrench"></i></div>
            <div class="nav-item logout-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
        </nav>

        <main class="main-content" id="dashboardView">
            <div class="header">
                <div><h1>TxMS PRO</h1><span id="roleDisplay" style="color:var(--text-muted)">System Operator</span><select id="deviceSelect" class="device-selector" onchange="switchDevice(this.value)"><option value="Tx01" selected>Tx01 (Main Node)</option></select></div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute Alarms"><i class="fa-solid fa-volume-high"></i></button>
                    <div id="netStatus" class="status-badge status-offline">CONNECTING...</div>
                </div>
            </div>

            <div class="card" style="padding: 0; margin-bottom: 25px; position: relative;">
                <div style="background: rgba(139, 92, 246, 0.1); padding: 12px 20px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between;">
                    <span style="font-size: 0.85rem; font-weight: bold; color: var(--accent-purple);">GEOSPATIAL FLEET MONITOR</span>
                    <button onclick="toggleGeoControls()" style="background: none; border: none; color: #555; cursor: pointer; font-size: 0.7rem;">MANAGE LOCATIONS</button>
                </div>
                
                <div id="geoControlsPanel" class="manual-geo-controls" style="display: none; border-bottom: 1px solid #333; margin: 0; border-radius: 0;">
                    <div style="flex-grow: 1;">
                        <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold;">UPDATE NODE LOCATION</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="inputDeviceId" class="geo-input" value="Tx01" readonly>
                            <input type="number" id="inputLat" class="geo-input" placeholder="Latitude" step="0.000001">
                            <input type="number" id="inputLng" class="geo-input" placeholder="Longitude" step="0.000001">
                            <button class="geo-btn" onclick="saveManualLocation()"><i class="fa-solid fa-plus"></i> UPDATE</button>
                        </div>
                    </div>
                </div>

                <div id="map" style="border: none; margin: 0; border-radius: 0 0 20px 20px;"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" id="card_v"><i class="fa-solid fa-bolt stat-icon" style="color: #7c3aed;"></i><div class="stat-value" id="v">--</div><div class="stat-label">Main Voltage</div><div class="stat-pill" style="background: #7c3aed;">Real-time</div></div>
                <div class="stat-card" id="card_c"><i class="fa-solid fa-plug stat-icon" style="color: #06b6d4;"></i><div class="stat-value"><span id="c1">--</span> / <span id="c2">--</span></div><div class="stat-label">Current (L1 / L2)</div><div class="stat-pill" style="background: #06b6d4;">Amperage</div></div>
                <div class="stat-card" id="card_pf"><i class="fa-solid fa-wave-square stat-icon" style="color: #d946ef;"></i><div class="stat-value" id="pf">--</div><div class="stat-label">Power Factor</div><div class="stat-pill" style="background: #d946ef;">Efficiency</div></div>
                <div class="stat-card" id="card_t"><i class="fa-solid fa-temperature-half stat-icon" style="color: #ef4444;"></i><div class="stat-value" id="t">--</div><div class="stat-label">Transformer Temp</div><div class="stat-pill" style="background: #ef4444;">Thermal</div></div>
                <div class="stat-card" id="card_vib"><i class="fa-solid fa-bell stat-icon" style="color: #fbbf24;"></i><div class="stat-value" id="vib">--</div><div class="stat-label">Vibration Level</div><div class="stat-pill" style="background: #fbbf24;">Physical</div></div>
            </div>

            <div class="dashboard-split">
                <div class="card big-chart-card">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color:white; font-size:1rem;">Real Time Current Analysis</h3>
                        <span style="color:var(--text-muted); font-size:0.8rem;">Load balance monitoring</span>
                    </div>
                    <div class="chart-box"><canvas id="chartCurr"></canvas></div>
                </div>

                <div class="small-charts-grid">
                    <div class="card small-chart-card"><div class="chart-header"><span>Voltage</span></div><div class="chart-box"><canvas id="chartVolt"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>PF Trend</span></div><div class="chart-box"><canvas id="chartPF"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>Temp</span></div><div class="chart-box"><canvas id="chartTemp"></canvas></div></div>
                    <div class="card small-chart-card"><div class="chart-header"><span>Vibration</span></div><div class="chart-box"><canvas id="chartVib"></canvas></div></div>
                </div>
            </div>
        </main>

        <div class="history-overlay" id="historyView">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div><h2>ANALYTICAL HISTORIAN</h2><span style="color:var(--text-muted); font-size: 0.8rem;">Session Log</span></div>
                <div><button class="btn-action" style="background:#333;" onclick="showView('dashboardView')">CLOSE</button></div>
            </div>
            <div class="card" style="height:500px; padding:20px;"><canvas id="historyChart"></canvas></div>
        </div>
        
        <div class="daily-overlay" id="dailyView">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <div><h2>DAILY REPORT</h2></div>
                <button class="btn-action" style="background:#333" onclick="showView('dashboardView')">CLOSE</button>
            </div>
            <div class="card" style="min-height: 500px;"><table class="data-table"><thead><tr><th>TIME</th><th>VOLT</th><th>L1</th><th>L2</th><th>TEMP</th><th>VIB</th></tr></thead><tbody id="dailyTableBody"></tbody></table></div>
        </div>

        <div class="maintenance-overlay" id="maintenanceView">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <div><h2>SYSTEM MAINTENANCE</h2><span style="color:var(--text-muted)">Admin Controls</span></div>
                <button class="btn-action" style="background:#333" onclick="showView('dashboardView')">CLOSE</button>
            </div>

             <div class="card" style="margin-bottom: 25px; border-color: #d946ef;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: white; font-size: 1rem;">Safety Interlock</h3>
                        <span style="color: #aaa; font-size: 0.8rem;">Master Alarm Control</span>
                    </div>
                    
                    <label class="switch">
                        <input type="checkbox" id="alarmToggle" onchange="toggleAlarm(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="armStatusText" style="margin-top: 10px; font-weight: bold; color: #ef4444; text-align: right;">DISARMED</div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION (REPLACE WITH YOUR RENDER URL) ---
    const API_URL = "https://txms-backend.onrender.com/api"; 
    const DEVICE_ID = "Tx01";

    // --- STATE VARIABLES ---
    let sessionLog = []; 
    let map = null;
    let deviceMarker = null;
    let isMuted = false;
    let pollInterval = null;

    // --- INIT AUDIO ---
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').classList.toggle('active', isMuted); }

    // --- LOGIN SYSTEM ---
    function login(){
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        if(email === "admin@txms.com" && pass === "admin123") {
            document.getElementById("loginView").style.display="none";
            document.getElementById("appContainer").style.display="block";
            initMap();
            startPolling();
        } else {
            document.getElementById("loginError").style.display="block";
        }
    }
    function logout(){ window.location.reload(); }

    // --- DATA FETCHING (POLLING RENDER) ---
    function startPolling() {
        fetchData();
        pollInterval = setInterval(fetchData, 2000);
    }

    async function fetchData() {
        try {
            const response = await fetch(`${API_URL}/status/${DEVICE_ID}`);
            const data = await response.json();

            if(data.message === "No data") return;

            document.getElementById('netStatus').innerText = "ONLINE";
            document.getElementById('netStatus').className = "status-badge status-online";
            
            updateDashboard(data);

        } catch (error) {
            console.error("Fetch Error:", error);
            document.getElementById('netStatus').innerText = "OFFLINE";
            document.getElementById('netStatus').className = "status-badge status-offline";
        }
    }

    // --- DASHBOARD UPDATES ---
    function updateDashboard(d) {
        const v = d.voltage || 0;
        const c1 = d.currentL1 || 0;
        const c2 = d.currentL2 || 0;
        const t = d.temp || 0;
        const vib = d.vib || 0;
        const pf = d.pf || 0;

        document.getElementById('v').innerText = v.toFixed(1)+"V";
        document.getElementById('pf').innerText = pf.toFixed(2); 
        document.getElementById('c1').innerText = c1.toFixed(1);
        document.getElementById('c2').innerText = c2.toFixed(1);
        document.getElementById('t').innerText = t.toFixed(1)+"Â°C";
        document.getElementById('vib').innerText = vib.toFixed(2)+"g";

        updateSingleChart(vChart, v); updateSingleChart(pfChart, pf); 
        updateSingleChart(tChart, t); updateSingleChart(vibChart, vib);
        
        cChart.data.datasets[0].data.push(c1); cChart.data.datasets[0].data.shift();
        cChart.data.datasets[1].data.push(c2); cChart.data.datasets[1].data.shift(); 
        cChart.update();

        if(d.config && d.config.location && d.config.location.lat !== 0) {
            const lat = d.config.location.lat;
            const lng = d.config.location.lng;
            if(map && deviceMarker) {
                deviceMarker.setLatLng([lat, lng]);
                map.setView([lat, lng], 14);
                document.getElementById('inputLat').value = lat;
                document.getElementById('inputLng').value = lng;
            }
        }

        // --- SYNC ALARM SWITCH FROM DATABASE ---
        if (d.alarmArmed !== undefined) {
            const toggle = document.getElementById('alarmToggle');
            const statusText = document.getElementById('armStatusText');
            
            if (toggle.checked !== d.alarmArmed) {
                toggle.checked = d.alarmArmed;
                if (d.alarmArmed) {
                    statusText.innerText = "SYSTEM ARMED";
                    statusText.style.color = "#ef4444";
                } else {
                    statusText.innerText = "SYSTEM DISARMED";
                    statusText.style.color = "#10b981";
                }
            }
        }

        const now = new Date();
        sessionLog.push({time: now, v, c1, c2, pf, t, vib});
        if (sessionLog.length > 2000) sessionLog.shift();
        
        updateHistoryTable();
    }

    // --- TOGGLE ALARM FUNCTION ---
    async function toggleAlarm(checkbox) {
        const newState = checkbox.checked;
        const statusText = document.getElementById('armStatusText');

        if (newState) {
            statusText.innerText = "ARMING...";
            statusText.style.color = "#ef4444";
        } else {
            statusText.innerText = "DISARMING...";
            statusText.style.color = "#10b981";
        }

        try {
            const response = await fetch(`${API_URL}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    device_id: DEVICE_ID, 
                    alarm_armed: newState 
                })
            });

            if (!response.ok) {
                alert("Failed to update alarm status!");
                checkbox.checked = !newState;
            }
        } catch (error) {
            console.error("Control Error:", error);
            alert("Network Error: Could not talk to server.");
            checkbox.checked = !newState; 
        }
    }

    // --- MAP FUNCTIONS ---
    function initMap() {
        if(map) return;
        map = L.map('map').setView([14.5995, 120.9842], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class='marker-normal'></div>` });
        deviceMarker = L.marker([14.5995, 120.9842], {icon: icon}).addTo(map);
        deviceMarker.bindPopup("Tx01 (Main Transformer)");
    }

    function toggleGeoControls() {
        const p = document.getElementById('geoControlsPanel');
        p.style.display = p.style.display === 'none' ? 'flex' : 'none';
        if(map) map.invalidateSize();
    }

    async function saveManualLocation() {
        const lat = parseFloat(document.getElementById('inputLat').value);
        const lng = parseFloat(document.getElementById('inputLng').value);
        
        if(!lat || !lng) return alert("Invalid Coords");

        await fetch(`${API_URL}/location`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ device_id: DEVICE_ID, lat, lng })
        });
        alert("Location Updated!");
    }

    // --- CHARTS & UI ---
    function createMiniChart(e,t){return new Chart(document.getElementById(e).getContext("2d"),{type:"line",data:{labels:Array(20).fill(""),datasets:[{data:Array(20).fill(0),borderColor:t,borderWidth:2,pointRadius:0,tension:.4,fill:!0,backgroundColor:t+"11"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{display:!1},y:{display:!0,grid:{color:"#333"},ticks:{color:"#bbb",font:{size:11}}}},plugins:{legend:{display:!1}},animation:!1}})}
    const vChart=createMiniChart("chartVolt","#7c3aed"),pfChart=createMiniChart("chartPF","#d946ef"),tChart=createMiniChart("chartTemp","#ef4444"),vibChart=createMiniChart("chartVib","#fbbf24"),cChart=new Chart(document.getElementById("chartCurr").getContext("2d"),{type:"line",data:{labels:Array(20).fill(""),datasets:[{label:"L1",data:Array(20).fill(0),borderColor:"#10b981",borderWidth:2,pointRadius:0,tension:.4},{label:"L2",data:Array(20).fill(0),borderColor:"#06b6d4",borderWidth:2,pointRadius:0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{display:!1},y:{display:!0,grid:{color:"#444"},ticks:{color:"#ffffff",font:{size:12,weight:"bold"}}}},plugins:{legend:{display:!0,labels:{color:"#ccc"}}},animation:!1}});
    function updateSingleChart(e,t){e.data.datasets[0].data.push(t),e.data.datasets[0].data.shift(),e.update()}

    function showView(e){
        // Hide all views first
        ["dashboardView","historyView","dailyView","maintenanceView"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display="none";
        });
        // Show the requested view
        const target = document.getElementById(e);
        if(target) target.style.display="block";
        
        // Map resize fix
        if(e === 'dashboardView' && map) setTimeout(()=>map.invalidateSize(), 200);
    }

    function updateHistoryTable() {
        const tbody = document.getElementById("dailyTableBody");
        tbody.innerHTML = "";
        const recent = sessionLog.slice(-20).reverse();
        recent.forEach(d => {
            let row = `<tr><td>${d.time.toLocaleTimeString()}</td><td>${d.v.toFixed(1)}</td><td>${d.c1.toFixed(1)}</td><td>${d.c2.toFixed(1)}</td><td>${d.t.toFixed(1)}</td><td>${d.vib.toFixed(2)}</td></tr>`;
            tbody.insertAdjacentHTML("beforeend", row);
        });
    }

</script>
</body>
</html>
